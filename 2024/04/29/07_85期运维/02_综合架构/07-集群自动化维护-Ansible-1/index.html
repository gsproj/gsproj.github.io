<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>07-集群自动化维护-Ansible(一) | Haris的小站</title><meta name="author" content="Haris"><meta name="copyright" content="Haris"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ansible集群自动化维护1.1 Ansible概述市面上的部分批量管理工具    批量管理工具 说明    Ansible 无客户端,基于ssh进行管理与维护.   Saltstack 需要安装客户端,基于ssh进行管理,与ansible.   terraform tf批量管理基础设施(批量创建100台公有云)   Ansible是其中一种，基于Python语言实现，用于集群批量管理，批量分发">
<meta property="og:type" content="article">
<meta property="og:title" content="07-集群自动化维护-Ansible(一)">
<meta property="og:url" content="http://gsproj.github.io/2024/04/29/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/07-%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4-Ansible-1/index.html">
<meta property="og:site_name" content="Haris的小站">
<meta property="og:description" content="Ansible集群自动化维护1.1 Ansible概述市面上的部分批量管理工具    批量管理工具 说明    Ansible 无客户端,基于ssh进行管理与维护.   Saltstack 需要安装客户端,基于ssh进行管理,与ansible.   terraform tf批量管理基础设施(批量创建100台公有云)   Ansible是其中一种，基于Python语言实现，用于集群批量管理，批量分发">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://gsproj.github.io/img/%E5%A4%B4%E5%83%8F.png">
<meta property="article:published_time" content="2024-04-29T08:35:52.000Z">
<meta property="article:modified_time" content="2024-08-02T01:48:34.361Z">
<meta property="article:author" content="Haris">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://gsproj.github.io/img/%E5%A4%B4%E5%83%8F.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "07-集群自动化维护-Ansible(一)",
  "url": "http://gsproj.github.io/2024/04/29/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/07-%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4-Ansible-1/",
  "image": "http://gsproj.github.io/img/%E5%A4%B4%E5%83%8F.png",
  "datePublished": "2024-04-29T08:35:52.000Z",
  "dateModified": "2024-08-02T01:48:34.361Z",
  "author": [
    {
      "@type": "Person",
      "name": "Haris",
      "url": "http://gsproj.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://gsproj.github.io/2024/04/29/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/07-%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4-Ansible-1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '07-集群自动化维护-Ansible(一)',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/modify.css"><style>#article-container.post-content h1:before, h2:before, h3:before, h4:before, h5:before, h6:before { -webkit-animation: avatar_turn_around 1s linear infinite; -moz-animation: avatar_turn_around 1s linear infinite; -o-animation: avatar_turn_around 1s linear infinite; -ms-animation: avatar_turn_around 1s linear infinite; animation: avatar_turn_around 1s linear infinite; }</style><meta name="generator" content="Hexo 7.3.0"></head><body><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="/css/loading-bar.css"><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="web_bg" style="background-image: url(/img/猫.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">211</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/car2.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Haris的小站</span></a><a class="nav-page-title" href="/"><span class="site-name">07-集群自动化维护-Ansible(一)</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">07-集群自动化维护-Ansible(一)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-29T08:35:52.000Z" title="发表于 2024-04-29 16:35:52">2024-04-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-02T01:48:34.361Z" title="更新于 2024-08-02 09:48:34">2024-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/">（二）综合架构</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><div class="top-img" style="background-image: url(/img/car2.png);"></div><article class="container post-content" id="article-container"><h1 id="Ansible集群自动化维护"><a href="#Ansible集群自动化维护" class="headerlink" title="Ansible集群自动化维护"></a>Ansible集群自动化维护</h1><h2 id="1-1-Ansible概述"><a href="#1-1-Ansible概述" class="headerlink" title="1.1 Ansible概述"></a>1.1 Ansible概述</h2><p>市面上的部分批量管理工具</p>
<table>
<thead>
<tr>
<th>批量管理工具</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Ansible</td>
<td>无客户端,基于ssh进行管理与维护.</td>
</tr>
<tr>
<td>Saltstack</td>
<td>需要安装客户端,基于ssh进行管理,与ansible.</td>
</tr>
<tr>
<td>terraform</td>
<td>tf批量管理基础设施(批量创建100台公有云)</td>
</tr>
</tbody></table>
<p>Ansible是其中一种，基于Python语言实现，用于集群批量管理，批量分发，批量执行，维护等</p>
<h2 id="1-2-Ansible的管理框架"><a href="#1-2-Ansible的管理框架" class="headerlink" title="1.2 Ansible的管理框架"></a>1.2 Ansible的管理框架</h2><p>图示：</p>
<p><img src="/../../../img/image-20240429163838386.png" alt="image-20240429163838386"></p>
<p>详细解释：</p>
<ul>
<li>Inventory 主机机清单<ul>
<li>被管理主机的ip列表，分类.</li>
</ul>
</li>
<li>ad-hoc 模式：<ul>
<li>命令行批量管理(使用ans模块),临时任务.</li>
</ul>
</li>
<li>playbook 剧本模式<ul>
<li>类似于把操作写出脚本,可以重复运行这个脚本</li>
</ul>
</li>
</ul>
<h2 id="1-3-部署与配置"><a href="#1-3-部署与配置" class="headerlink" title="1.3 部署与配置"></a>1.3 部署与配置</h2><h3 id="1-3-1-安装"><a href="#1-3-1-安装" class="headerlink" title="1.3.1 安装"></a>1.3.1 安装</h3><p>在主控节点(mn01)安装ansible</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ansible</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-3-2-初始配置"><a href="#1-3-2-初始配置" class="headerlink" title="1.3.2 初始配置"></a>1.3.2 初始配置</h3><p>修改ansible的配置文件：</p>
<ul>
<li>关闭主机Host_key_checking .</li>
<li>开启日志功能</li>
</ul>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#cp /eegrep -vn "^$|#" /etc/ansible/ansible.cfg</span><br><span class="line">10:[defaults]</span><br><span class="line">71:host_key_checking = False	# *</span><br><span class="line">111:log_path = /var/log/ansible.log		# *</span><br><span class="line">327:[inventory]</span><br><span class="line">340:[privilege_escalation]</span><br><span class="line">346:[paramiko_connection]</span><br><span class="line">370:[ssh_connection]</span><br><span class="line">431:[persistent_connection]</span><br><span class="line">445:[accelerate]</span><br><span class="line">460:[selinux]</span><br><span class="line">469:[colors]</span><br><span class="line">485:[diff]</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>Host_key_checking如果没关闭，将造成如下报错：</p>
<p><img src="/../../../img/image-20240429170421990.png" alt="image-20240429170421990"></p>
</blockquote>
<h2 id="1-3-Ans-inventory主机清单"><a href="#1-3-Ans-inventory主机清单" class="headerlink" title="1.3  Ans-inventory主机清单"></a>1.3  Ans-inventory主机清单</h2><p>主机清单，就是让ansible管理的节点的列表，默认读取在<code>/etc/ansible/hosts</code>文件,并非/etc/hosts。</p>
<p>未来实际使用中一般我们会把主机清单文件存放在指定的目录中,运行ansible的时候通过<code>-i</code>选项指定主机清单文件即可  </p>
<h3 id="1-3-1-主机清单的格式"><a href="#1-3-1-主机清单的格式" class="headerlink" title="1.3.1 主机清单的格式"></a>1.3.1 主机清单的格式</h3><blockquote>
<p>主机清单格式：</p>
<p>[分类或分组的名字]			#注意分类要体现出服务器的作用</p>
<p>ip地址 或 主机名 或 域名 	#注意主机名要能解析才行  </p>
<p>命令格式：<br>ansible [主机ip 或 分组 或 all]  -m [指定使用的模块名字]</p>
</blockquote>
<p>案例01-对主机分组并进行连接测试  </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#cat /etc/ansible/hosts</span><br><span class="line">[web01]</span><br><span class="line">172.16.1.7</span><br><span class="line">[backup01]</span><br><span class="line">172.16.1.41</span><br><span class="line">[nfs01]</span><br><span class="line">172.16.1.31</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试, 这里的ping模块用于检查被管理端是否可以访问.</span>  </span><br><span class="line">[root@mn01[ /server/scripts]#ansible all -m ping</span><br><span class="line">172.16.1.41 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br><span class="line">172.16.1.31 | SUCCESS =&gt; {</span><br><span class="line">....</span><br><span class="line">172.16.1.7 | SUCCESS =&gt; {</span><br><span class="line">....</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-3-2-子组"><a href="#1-3-2-子组" class="headerlink" title="1.3.2 子组"></a>1.3.2 子组</h3><p>案例02: 我希望对backup01,nfs01两个主机分组,再创建个分区叫data分组 </p>
 <figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用children关键字，创建子组</span></span><br><span class="line">[root@mn01[ /server/scripts]#cat /etc/ansible/hosts</span><br><span class="line">[web01]</span><br><span class="line">172.16.1.7</span><br><span class="line">[backup01]</span><br><span class="line">172.16.1.41</span><br><span class="line">[nfs01]</span><br><span class="line">172.16.1.31</span><br><span class="line"></span><br><span class="line">[data:children]</span><br><span class="line">nfs01</span><br><span class="line">backup01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试</span></span><br><span class="line">[root@mn01[ /server/scripts]#ansible data -m ping</span><br><span class="line">172.16.1.41 | SUCCESS =&gt; {</span><br><span class="line">...</span><br><span class="line">}</span><br><span class="line">172.16.1.31 | SUCCESS =&gt; {</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-3-3-指定用户名和密码"><a href="#1-3-3-指定用户名和密码" class="headerlink" title="1.3.3 指定用户名和密码"></a>1.3.3 指定用户名和密码</h3><p>如果没有实现进行<em>密钥认证</em>配置，也可以通过修改配置文件来指定<em>用户名和密码</em></p>
<p>该方法<font color="red">不推荐</font></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">172.16.1.7 ansible_user=root ansible_password=redhat123	ansible_port=22</span><br></pre></td></tr></tbody></table></figure>

<p>案例：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先删除172.16.1.7的密钥认证文件，再次ansible会失败</span></span><br><span class="line">[root@mn01[ /server/scripts]#ansible 172.16.1.7 -m ping</span><br><span class="line">172.16.1.7 | UNREACHABLE! =&gt; {</span><br><span class="line">    "changed": false,</span><br><span class="line">    "msg": "Failed to connect to the host via ssh: Permission denied (publickey,password).",</span><br><span class="line">    "unreachable": true</span><br><span class="line">}</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置用户名和密码</span></span><br><span class="line">[root@mn01[ /server/scripts]#cat /etc/ansible/hosts</span><br><span class="line">[web01]</span><br><span class="line">172.16.1.7 ansible_user=root ansible_password=redhat123 ansible_port=22</span><br><span class="line">[backup01]</span><br><span class="line">172.16.1.41</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次测试成功访问</span></span><br><span class="line">[root@mn01[ /server/scripts]#ansible 172.16.1.7 -m ping</span><br><span class="line">172.16.1.7 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="1-4-Ansible必知必会的模块"><a href="#1-4-Ansible必知必会的模块" class="headerlink" title="1.4 Ansible必知必会的模块"></a>1.4 Ansible必知必会的模块</h2><p>Ansible模块概述:<br>ansible中的模块就类似于Linux中的命令,我们Linux命令管理系统,我们通过ansible模块实现批量管理.<br>ansible中模块一般相当于Linux中的一些命令.yum模块,file模块,user模块.<br>ansible中的模块拥有不同的选项,这些选项一般都是一些单词,拥有自己的格式与要求.  </p>
<table>
<thead>
<tr>
<th>模块分类</th>
<th>模块</th>
</tr>
</thead>
<tbody><tr>
<td>命令和脚本模块</td>
<td>command模块 ans默认的模块,执行简单命令,不支持特殊符号</td>
</tr>
<tr>
<td></td>
<td>shell模块 执行命令,支持特殊符号</td>
</tr>
<tr>
<td></td>
<td>script模块 分发脚本并执行</td>
</tr>
<tr>
<td>文件</td>
<td>file 创建目录,文件,软连接,</td>
</tr>
<tr>
<td></td>
<td>copy 远程分发文件,修改权限,所有者,备份</td>
</tr>
<tr>
<td>服务</td>
<td>systemd服务管理</td>
</tr>
<tr>
<td></td>
<td>service 服务管理(了解)</td>
</tr>
<tr>
<td>软件包</td>
<td>yum源 yum_repository</td>
</tr>
<tr>
<td></td>
<td>yum命令</td>
</tr>
<tr>
<td></td>
<td>get_url下载软件</td>
</tr>
<tr>
<td>系统管理</td>
<td>mount模块 挂载</td>
</tr>
<tr>
<td></td>
<td>cron模块 定时任务</td>
</tr>
<tr>
<td>用户管理</td>
<td>group模块 管理用户组</td>
</tr>
<tr>
<td></td>
<td>user模块 管理用户</td>
</tr>
<tr>
<td>其他可以研究</td>
<td>压缩解压(unarchive) ,rsync模块(synchronize),数据库模块(mysql_db,mysql_user)ՎՎʢ</td>
</tr>
<tr>
<td>其他</td>
<td>ansible管理docker k8s zabbix grafana ՎՎʢ</td>
</tr>
<tr>
<td>用于调试模块</td>
<td>ping 模块检查 ansible与其他节点连通性.</td>
</tr>
<tr>
<td></td>
<td>debug 模块 用于检查/显示 变量</td>
</tr>
</tbody></table>
<p>命令和模块使用方法描述</p>
<table>
<thead>
<tr>
<th>ansible</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>ansible</td>
<td>主机清单(all/web/172.16.1.7)</td>
<td>-m 模块</td>
<td>-a 模块中的选项</td>
</tr>
<tr>
<td>-i 指定主机清单文件</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-m 指定模块</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>-a 指定模块中的选项</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="1-4-1-命令与脚本类模块"><a href="#1-4-1-命令与脚本类模块" class="headerlink" title="1.4.1 命令与脚本类模块"></a>1.4.1 命令与脚本类模块</h3><h4 id="a-command模块"><a href="#a-command模块" class="headerlink" title="a) command模块"></a>a) command模块</h4><p>command模块是ansible的默认模块，适用于执行简单的命令，不支持特殊符号</p>
<p>案例：批量获取所有主机的ens33网卡信息</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m command -a 'ip a s ens33'</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">因为<span class="built_in">command</span>是默认模块，可以省略指定</span></span><br><span class="line">ansible all -a 'ip a s ens33'</span><br></pre></td></tr></tbody></table></figure>

<h4 id="b-shell模块"><a href="#b-shell模块" class="headerlink" title="b) shell模块"></a>b) shell模块</h4><p>与command模块类似，但是shell模块<em>支持特殊符号</em></p>
<p>案例1：批量删除/tmp下面的所有内容</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#ansible all -m shell -a 'rm -fr /tmp/*'</span><br><span class="line">[WARNING]: Consider using the file module with state=absent rather than running 'rm'.  If you need to use command because file is insufficient you can add 'warn: false' to this command task or set</span><br><span class="line">'command_warnings=False' in ansible.cfg to get rid of this message.</span><br><span class="line">172.16.1.41 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">172.16.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">172.16.1.7 | CHANGED | rc=0 &gt;&gt;</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>删除文件会有warning提示，建议用file模块来操作</p>
</blockquote>
<p>案例2：批量获取IP地址</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#ansible all -m shell -a "ip a s ens33 | awk -F'[ /]+' 'NR==3{print \$3}'"</span><br><span class="line">172.16.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">10.0.0.31</span><br><span class="line">172.16.1.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">10.0.0.7</span><br><span class="line">172.16.1.41 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">10.0.0.41</span><br></pre></td></tr></tbody></table></figure>

<h4 id="c-script-模块"><a href="#c-script-模块" class="headerlink" title="c) script 模块"></a>c) script 模块</h4><p>用于分发和执行脚本</p>
<p>案例：在所有主机中执行指定脚本</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#cat /server/scripts/ansible-script.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bashh</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">desc: 系统巡检脚本</span></span><br><span class="line">hostname</span><br><span class="line">hostname -I</span><br><span class="line">ip a s ens33 |awk -F'[ /]+' 'NR==3{print $3}'</span><br><span class="line">uptime</span><br><span class="line">whoami</span><br><span class="line">date +%F</span><br><span class="line">sleep 10</span><br></pre></td></tr></tbody></table></figure>

<p>分发执行脚本</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#ansible all -m script -a '/server/scripts/ansible-script.sh'</span><br><span class="line">172.16.1.7 | CHANGED =&gt; {</span><br><span class="line">    "changed": true,</span><br><span class="line">....</span><br><span class="line">    "stdout_lines": [</span><br><span class="line">        "web01",</span><br><span class="line">        "10.0.0.7 172.16.1.7 ",</span><br><span class="line">        "10.0.0.7",</span><br><span class="line">        " 09:49:47 up 1 day, 17:52,  2 users,  load average: 0.00, 0.01, 0.05",</span><br><span class="line">        "root",</span><br><span class="line">        "2024-04-30"</span><br><span class="line">    ]</span><br><span class="line">172.16.1.31 ....</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-4-2-文件相关的模块"><a href="#1-4-2-文件相关的模块" class="headerlink" title="1.4.2 文件相关的模块"></a>1.4.2 文件相关的模块</h3><h4 id="a-file模块"><a href="#a-file模块" class="headerlink" title="a) file模块"></a>a) file模块</h4><p>作用：</p>
<ul>
<li>file模块不仅可以管理文件,还可以管理目录,管理软连接.</li>
<li>相当于把touch命令,mkdir命令,rm命令,ln -s命令结合在一起了.</li>
</ul>
<table>
<thead>
<tr>
<th>file模块</th>
<th>模块说明</th>
</tr>
</thead>
<tbody><tr>
<td>path</td>
<td>路径(目录,文件) 必须要写</td>
</tr>
<tr>
<td>src</td>
<td>source源,源文件一般用于link(创建软连接模式) 用于指定源文件</td>
</tr>
<tr>
<td>state</td>
<td>状态(模式) ,具体要做的什么,创建/删除,操作文件/操作目录 state=directory 创建目录 state=file (默认) 更新文件,如果文件不存在也不创建 state=link 创建软连接 state=touch 创建文件</td>
</tr>
<tr>
<td></td>
<td>state=absent 删除 (⚠ 注意如果是目录递归删除目录. )</td>
</tr>
<tr>
<td>mode</td>
<td>mode=755创建并修改权限</td>
</tr>
<tr>
<td>onwer</td>
<td>onwer=root</td>
</tr>
<tr>
<td>group</td>
<td>group=root</td>
</tr>
</tbody></table>
<p>案例1：创建/opt/test.txt文件</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#ansible all -m file -a 'path=/opt/test.txt state=touch'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否创建成功</span></span><br><span class="line">[root@web01[ /upload]#tree /opt/</span><br><span class="line">/opt/</span><br><span class="line">└── test.txt</span><br></pre></td></tr></tbody></table></figure>

<p>案例2：创建目录（可以直接多级）</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#ansible all -m file -a 'path=/app/a/b/c/d state=directory'</span><br><span class="line">172.16.1.41 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python"</span><br><span class="line">    },</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否创建成功</span></span><br><span class="line">[root@web01[ /upload]#tree /app/</span><br><span class="line">/app/</span><br><span class="line">└── a</span><br><span class="line">    └── b</span><br><span class="line">        └── c</span><br><span class="line">            └── d</span><br></pre></td></tr></tbody></table></figure>

<p>案例3：创建软连接</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/hosts软连接到/opt下</span></span><br><span class="line">[root@mn01[ /server/scripts]#ansible all -m file -a 'src=/etc/hosts path=/opt/hosts state=link'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否创建成功</span></span><br><span class="line">[root@mn01[ /server/scripts]#ansible all -a 'ls /opt -l'</span><br><span class="line">172.16.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx. 1 root root 10 Apr 30 09:58 hosts -&gt; /etc/hosts</span><br><span class="line">-rw-r--r--. 1 root root  0 Apr 30 09:54 test.txt</span><br><span class="line">172.16.1.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx. 1 root root 10 Apr 30 09:58 hosts -&gt; /etc/hosts</span><br><span class="line">-rw-r--r--. 1 root root  0 Apr 30 09:54 test.txt</span><br><span class="line">172.16.1.41 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx. 1 root root 10 Apr 30 09:58 hosts -&gt; /etc/hosts</span><br><span class="line">-rw-r--r--. 1 root root  0 Apr 30 09:54 test.txt</span><br></pre></td></tr></tbody></table></figure>

<p>案例4：创建/ans-backup目录，所有者是oldboy，权限是700</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m file -a 'path=/ans-backup/</span><br><span class="line">owner=oldboy group=oldboy mode=700 state=directory'</span><br></pre></td></tr></tbody></table></figure>

<p>案例5：删除/ans-backup目录</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ /server/scripts]#ansible all -m file -a 'path=/ans-backup/ state=absent'</span><br><span class="line">172.16.1.41 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python"</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>温馨提示:</p>
<p>查看模块的帮助,可以通过<code>ansible-doc -s</code>模块名查看，如：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">ansible-doc -s file</span></span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<h4 id="b-copy模块"><a href="#b-copy模块" class="headerlink" title="b) copy模块"></a>b) copy模块</h4><p>批量分发：类似于scp，1个节点(管理节点)发送文件或压缩包到所有被管理端. </p>
<p>注意：copy是单向的传输。</p>
<table>
<thead>
<tr>
<th>copy模块</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>src</td>
<td>source 源文件,管理端的某个文件.</td>
</tr>
<tr>
<td>dest</td>
<td>destination 目标,被管理端的目录/文件.</td>
</tr>
<tr>
<td>backup</td>
<td>backup=yes 则会在覆盖前进行备份,文件内容要有变化或区别.</td>
</tr>
<tr>
<td>mode</td>
<td>修改权限</td>
</tr>
<tr>
<td>owner</td>
<td>修改为指定所有者</td>
</tr>
<tr>
<td>group</td>
<td>修改为指定用户组</td>
</tr>
</tbody></table>
<p>案例：分发书写好的/etc/hosts文件，如果文件存在则备份</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看文件内容</span></span><br><span class="line">[root@mn01[ ~]#cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">172.16.1.7 web01</span><br><span class="line">172.16.1.31 nfs01</span><br><span class="line">172.16.1.41 backup01</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分发</span></span><br><span class="line">[root@mn01[ ~]#ansible all -m copy -a 'src=/etc/hosts dest=/etc/hosts backup=yes'</span><br><span class="line">172.16.1.7 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python"</span><br><span class="line">    },</span><br><span class="line">    "backup_file": "/etc/hosts.28793.2024-04-30@10:11:37~",</span><br><span class="line">....</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">[root@mn01[ ~]#ansible all -m shell -a 'tree /etc | grep hosts'</span><br><span class="line">172.16.1.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">├── hosts</span><br><span class="line">├── hosts.28793.2024-04-30@10:11:37~</span><br><span class="line">...</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; ├── denyhosts</span><br><span class="line">172.16.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">├── hosts</span><br><span class="line">├── hosts.39547.2024-04-30@10:11:37~</span><br><span class="line">...</span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; │&nbsp;&nbsp; ├── denyhosts</span><br><span class="line">172.16.1.41 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">├── hosts</span><br><span class="line">├── hosts.105718.2024-04-30@10:11:37~</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure>

<h4 id="c-lineinfile模块"><a href="#c-lineinfile模块" class="headerlink" title="c) lineinfile模块"></a>c) lineinfile模块</h4><p>未来修改配置文件使用,类似于sed -i ‘sg’和sed ‘cai’.<br>未来使用的时候讲解  </p>
<h3 id="1-4-3-服务管理模块"><a href="#1-4-3-服务管理模块" class="headerlink" title="1.4.3 服务管理模块"></a>1.4.3 服务管理模块</h3><p>systemd模块相当于是linux systemctl命令：</p>
<ul>
<li>开启/关闭/重启服务</li>
<li>开机自启动</li>
</ul>
<table>
<thead>
<tr>
<th>systemd模块</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>用于指定服务名称</td>
</tr>
<tr>
<td>enabled</td>
<td>yes开机自启动 (yes/no)</td>
</tr>
<tr>
<td>state</td>
<td>表示服务开,关,重启…. state=started 开启 state=stopped 关闭 state=reloaded 重读配置文件(服务支持) state=restarted 重启(关闭再开启)</td>
</tr>
<tr>
<td>daemon-reload</td>
<td>yes是否重新加载对应的服务的管理配置文件(未来讲解书写systemctl配置文件)</td>
</tr>
</tbody></table>
<p>案例：开启crond服务并设置开机自启动；关闭firewalld服务并不让开机自启动  </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动服务</span></span><br><span class="line">ansible all -m systemd -a 'name=crond enabled=yes state=started'</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭服务</span></span><br><span class="line">ansible all -m systemd -a 'name=firewalld enabled=no state=stopped'</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启ssh</span></span><br><span class="line">ansible all -m systemd -a 'name=sshd state=restarted'</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>额外扩展:</p>
<ul>
<li>systemd模块适用于目前大部分的Linux系统.</li>
<li>service模块适用于管理旧的Linux系统</li>
</ul>
</blockquote>
<h3 id="1-4-4-软件管理模块"><a href="#1-4-4-软件管理模块" class="headerlink" title="1.4.4 软件管理模块"></a>1.4.4 软件管理模块</h3><p>分为：</p>
<ul>
<li>yum模块</li>
<li>get_url模块，类似于wget命令</li>
<li>yum_repository模块，yum源配置模块，还是建议通过copy模块分发.</li>
</ul>
<h4 id="a-yum模块"><a href="#a-yum模块" class="headerlink" title="a) yum模块"></a>a) yum模块</h4><p>yum模块并不只是yum命令,包含了yum/apt命令  </p>
<table>
<thead>
<tr>
<th>yum模块</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>指定软件包名字,可以指定多个,通过”,”分割.</td>
</tr>
<tr>
<td>state</td>
<td>installed 安装(也可以写为present)(默认) removed 删除 (也可以写为absent) lastest 安装或更新</td>
</tr>
<tr>
<td>update_cache</td>
<td>可以设置为no加加速,表示不更新本地yum缓存.实际应用建议开启</td>
</tr>
</tbody></table>
<p>案例: 安装常用的软件htop,tree,lrzsz,sshpass</p>
  <figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ ~]#ansible all -m yum -a 'name=htop,tree,lrzsz,sshpass'</span><br></pre></td></tr></tbody></table></figure>

<h4 id="b-get-url模块"><a href="#b-get-url模块" class="headerlink" title="b) get_url模块"></a>b) get_url模块</h4><p>相当于是wget命令.所有主机能访问网络才行.<br>推荐在管理节点下载好,使用copy仅分发即可  </p>
<table>
<thead>
<tr>
<th>get_url下载功能</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>url</td>
<td>指定要下载的地址</td>
</tr>
<tr>
<td>dest</td>
<td>下载到哪个目录</td>
</tr>
</tbody></table>
<p>案例：下载zabbix。。。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建目录</span></span><br><span class="line">[root@mn01[ ~]#ansible all -m file -a "path=/app/tools state=directory"</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@mn01[ ~]#ansible all -m get_url -a 'url="https://mirrors.aliyun.com/zabbix/zabbix/6.0/rhel/7/x86_64/zabbix-agent-6.0.13-release1.el7.x86_64.rpm" dest=/app/tools/'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">后续可以调用yum模块安装本地的软件</span></span><br><span class="line">name=/app/tools/xxxxx.rpm即可.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">[root@mn01[ ~]#ansible all -a 'tree /app/tools'</span><br><span class="line">172.16.1.41 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/app/tools</span><br><span class="line">└── zabbix-agent-6.0.13-release1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br><span class="line">172.16.1.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/app/tools</span><br><span class="line">└── zabbix-agent-6.0.13-release1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br><span class="line">172.16.1.31 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/app/tools</span><br><span class="line">...</span><br><span class="line">└── zabbix-agent-6.0.13-release1.el7.x86_64.rpm</span><br></pre></td></tr></tbody></table></figure>

<h4 id="c-yum-repository模块"><a href="#c-yum-repository模块" class="headerlink" title="c) yum_repository模块"></a>c) yum_repository模块</h4><p>了解即可，建议未来书写好yum配置文件,copy分发过去即可  </p>
<table>
<thead>
<tr>
<th>yum源模块 yum_repository</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>yum源中名字 [epel]</td>
</tr>
<tr>
<td>description</td>
<td>yum源的注释说明 对应的 是name的内容</td>
</tr>
<tr>
<td>baseurl</td>
<td>yum源中 baseurl 下载地址</td>
</tr>
<tr>
<td>enabled</td>
<td>是否启动这个源 yes/no</td>
</tr>
<tr>
<td>gpgcheck</td>
<td>是否启动gpgcheck功能 no</td>
</tr>
<tr>
<td>file</td>
<td>指定yum源的文件 自动添加 .repo 默认与模块名字一致.</td>
</tr>
</tbody></table>
<p>例如，以下repo源</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@m01 ~]# cat /etc/yum.repos.d/epel.repo</span><br><span class="line">[epel]</span><br><span class="line">name=Extra Packages for Enterprise Linux 7 -</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">basearch</span></span><br><span class="line">baseurl=http:Վˌmirrors.aliyun.com/epel/7/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></tbody></table></figure>

<p>使用ansible配置</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-m yum_repository</span><br><span class="line">-a 'name=epel description="Extra Packages for Enterprise Linux</span><br><span class="line">7 - $basearch" baseurl="http://mirrors.aliyun.com/epel/7/$basearch"</span><br><span class="line">enabled=yes</span><br><span class="line">gpgcheck=no</span><br><span class="line">'</span><br></pre></td></tr></tbody></table></figure>

<p>对比如下：</p>
<table>
<thead>
<tr>
<th>yum配置文件内容</th>
<th>yum源的模块的选项</th>
</tr>
</thead>
<tbody><tr>
<td>[epel]</td>
<td>name=epel #默认yum源文件的名字与这个一致.</td>
</tr>
<tr>
<td>name=Extra Pxxxxx</td>
<td>description=”Extra xxxxxxx”</td>
</tr>
<tr>
<td>baseurl=http:Վˌmirrors.aliyun.com/epel/7/$basea rch</td>
<td>baseurl=”http:Վˌmirrors.aliyun.com/epel/7/$basear ch”</td>
</tr>
<tr>
<td>enabled=1</td>
<td>enabled=yes</td>
</tr>
<tr>
<td>gpgcheck=0</td>
<td>gpgcheck=no</td>
</tr>
</tbody></table>
<p>案例：给web服务器配置nginx的yum源（http暂用test代替s）</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@mn01[ ~]#ansible web01 -m yum_repository -a 'name=nginx-stable description=nginx-stable-repo baseurl=http:/test gpgcheck=yes enabled=yes'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看效果</span></span><br><span class="line">[root@web01[ /upload]#cat /etc/yum.repos.d/nginx-stable.repo</span><br><span class="line">[nginx-stable]</span><br><span class="line">baseurl = http:/test</span><br><span class="line">enabled = 1</span><br><span class="line">gpgcheck = 1</span><br><span class="line">name = nginx-stable-repo</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-4-5-用户管理模块"><a href="#1-4-5-用户管理模块" class="headerlink" title="1.4.5 用户管理模块"></a>1.4.5 用户管理模块</h3><p>分为：</p>
<ul>
<li>user用户管理：useradd，userdel</li>
<li>group用户组管理：groupadd</li>
</ul>
<h4 id="a-user模块"><a href="#a-user模块" class="headerlink" title="a) user模块"></a>a) user模块</h4><table>
<thead>
<tr>
<th>user模块</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>wwww 用户名</td>
</tr>
<tr>
<td>uid</td>
<td>指定uid</td>
</tr>
<tr>
<td>group</td>
<td>指定用户组,一般用于事先创建好了用户组,通过选项指定下.</td>
</tr>
<tr>
<td>shell</td>
<td>指定命令解释器:默认是/bin/bash，可改成如/sbin/nologin</td>
</tr>
<tr>
<td>create_home</td>
<td>是否创建家目录(yes/no)</td>
</tr>
<tr>
<td>state</td>
<td>present 添加；absent 删除</td>
</tr>
<tr>
<td>password</td>
<td>加密的密码.</td>
</tr>
</tbody></table>
<p>案例: 创建www-ans用户uid 2000虚拟用户 </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m user -a 'name=www-ans uid=2000 shell=/sbin/nologin create_home=no state=present'</span><br></pre></td></tr></tbody></table></figure>

<p>案例：批量更新密码，更新用户gs的密码</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m user -a "name=gs password={{'1' | password_hash('sha512', 'lidao') }} state=present"</span><br></pre></td></tr></tbody></table></figure>

<p>也可以用shell模块更新</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m shell -a 'echo 1 |passwd --stdin gs'</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>关于<code>{{}}</code>相关的解释：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">{{ <span class="string">'1'</span> | password_hash(<span class="string">'sha512'</span>, <span class="string">'lidao'</span>) }}</span></span><br></pre></td></tr></tbody></table></figure>

<p>表示1是密码,经过管道,传递给了password_hash()插件, sha512加密算法，lidao是随机字符用于生成随机加密后的密码  </p>
</blockquote>
<h4 id="b-group模块"><a href="#b-group模块" class="headerlink" title="b) group模块"></a>b) group模块</h4><table>
<thead>
<tr>
<th>group</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>指定用户组名字</td>
</tr>
<tr>
<td>gid</td>
<td>指定组的gid</td>
</tr>
<tr>
<td>state</td>
<td>present添加 absent 删除</td>
</tr>
</tbody></table>
<p>案例：添加用户组gs</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加</span></span><br><span class="line">[root@mn01[ ~]#ansible all -m group -a 'name=gs gid=1003 state=present'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">[root@nfs01[ /opt]#cat /etc/group</span><br><span class="line">...</span><br><span class="line">gs:x:1003:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除</span></span><br><span class="line">[root@mn01[ ~]#ansible all -m group -a 'name=gs gid=1003 state=absent'</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-4-6-mount模块"><a href="#1-4-6-mount模块" class="headerlink" title="1.4.6 mount模块"></a>1.4.6 mount模块</h3><p>mount模块，实现mount命令进行挂载可以修改/etc/fstab实现永久挂载.  </p>
<table>
<thead>
<tr>
<th>mount选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>fstype</td>
<td>filesystem type指定文件系统,xfs,ext4,iso9660,nfs</td>
</tr>
<tr>
<td>src</td>
<td>源地址(nfs地址 eg 172.16.1.31/data )</td>
</tr>
<tr>
<td>path</td>
<td>注意这里不是dest,挂载点(要把源挂载到哪里)</td>
</tr>
<tr>
<td>state</td>
<td>参考下表</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>mount模块的state参数可使用的值</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>absent</td>
<td>卸载并修改fstab</td>
</tr>
<tr>
<td>unmounted</td>
<td>卸载不修改/etc/fstab</td>
</tr>
<tr>
<td>present</td>
<td>仅修改/etc/fstab 不挂载</td>
</tr>
<tr>
<td>mounted</td>
<td>挂载并修改/etc/fstab</td>
</tr>
<tr>
<td>remounted</td>
<td>重新挂载</td>
</tr>
</tbody></table>
<p>案例17: 通过ans管理在web01上挂载nfs:/data挂载到web01的/ans-upload/  </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在web服务器上安装nfs</span></span><br><span class="line">ansible web01 -m yum -a 'name=nfs-utils state=present'</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建挂载点</span></span><br><span class="line">ansible web01 -m file -a 'path=/ans-upload/ state=directory'</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">挂载nfs</span></span><br><span class="line">ansible web01 -m mount -a 'src=172.16.1.31:/data/ path=/ans-upload/ fstype=nfs state=mounted '</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检查已挂载上</span></span><br><span class="line">[root@mn01[ ~]#ansible web01 -a 'df -h'</span><br><span class="line">172.16.1.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">...</span><br><span class="line">172.16.1.31:/data         50G  2.5G   48G   5% /upload</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">fstab已写入</span></span><br><span class="line">[root@mn01[ ~]#ansible web01 -a 'grep upload /etc/fstab '</span><br><span class="line">172.16.1.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">172.16.1.31:/data/ /ans-upload/ nfs defaults 0 0</span><br></pre></td></tr></tbody></table></figure>

<h3 id="1-4-7-cron模块"><a href="#1-4-7-cron模块" class="headerlink" title="1.4.7 cron模块"></a>1.4.7 cron模块</h3><p>用于管理系统的定时任务,替代了<code>crontab -e</code>功能  </p>
<table>
<thead>
<tr>
<th>cron模块 选项</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>定时任务名字(一定要加上), 对应下面 注释 的内容</td>
</tr>
<tr>
<td>minute</td>
<td>分钟 minute=”*/2”</td>
</tr>
<tr>
<td>hour</td>
<td>小时</td>
</tr>
<tr>
<td>day</td>
<td>日期</td>
</tr>
<tr>
<td>month</td>
<td>月份</td>
</tr>
<tr>
<td>week</td>
<td>周几</td>
</tr>
<tr>
<td>job</td>
<td>指定命令或脚本(定向到空) job=”/sbin/ntpdate ntp1.aliyun.com &amp;&gt;/dev/null”</td>
</tr>
<tr>
<td>state</td>
<td>present 添加定时任务(默认) absent 删除</td>
</tr>
</tbody></table>
<p>案例: 每3分钟同步时间.  </p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1. <span class="built_in">sync</span> time 原写法</span></span><br><span class="line">*/3 * * * * /sbin/ntpdate ntp1.aliyun.com &amp;&gt;/dev/null</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.清理已有的定时任务</span></span><br><span class="line">ansible all -a "sed -i '/ntpdate/d' /var/spool/cron/root"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3.重新添加定时任务</span></span><br><span class="line">ansible all -m cron -a 'name="sync time by lidao996" minute="*/3" job="/sbin/ntpdate ntp1.aliyun.com &amp;&gt;/dev/null" state=present'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.删除</span></span><br><span class="line">ansible all -m cron -a ' name="sync time by lidao996" state=absent'</span><br></pre></td></tr></tbody></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://gsproj.github.io">Haris</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://gsproj.github.io/2024/04/29/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/07-%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4-Ansible-1/">http://gsproj.github.io/2024/04/29/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/07-%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4-Ansible-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://gsproj.github.io" target="_blank">Haris的小站</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/%E5%A4%B4%E5%83%8F.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/04/29/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/06-%E5%AF%86%E9%92%A5%E8%AE%A4%E8%AF%81/" title="06-密钥认证"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">06-密钥认证</div></div><div class="info-2"><div class="info-item-1">一、密钥认证-集群批量管理1.1 概述作用：  使管理更加轻松，两个节点通过密钥形式进行访问，不需要输入密码（单向）  应用场景：  一些服务在使用前要求我们做秘钥认证. 手动写批量管理脚本.  别名：  密钥认证 免密码登录 双机互信  1.2 密钥认证的原理图示如下：   什么是密钥对? 公钥: public key 一般以.pub结尾.私钥: private key 没有特殊的结尾    1.3 配置密钥认证环境准备    角色 主机名 ip    管理机 m01 10.0.0.61   被管理节点 nfs01 10.0.0.31   被管理节点 web01 10.0.0.7   被管理节点 backup 10.0.0.41   1.3.1 基本检查确保对向机器IP和端口正常 12345678910111213141516#pingping 172.16.1.41# nmap探测22端口，sshd服务开启或可以访问[root@mn01[ ~]#nmap -p 22 172.16.1.31 172.16.1.7 172.16.1.41Starting Nmap 6.40 (...</div></div></div></a><a class="pagination-related" href="/2024/05/04/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/08-%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4-Ansible-2/" title="08-集群自动化维护-Ansible(二)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">08-集群自动化维护-Ansible(二)</div></div><div class="info-2"><div class="info-item-1">Ansible集群自动化维护（二）主要内容：剧本和变量 1 剧本1.1 剧本介绍什么是ansible的剧本(play book)？  剧本是一个yaml格式的文件，用于长久保存并且实现批量管理、维护、部署的文件。 类似于脚本存放命令和变量，剧本中存放各模块的使用命令 剧本是未来我们批量管理、运维必会的内容  剧本和ansible命令的区别：     ansible剧本 ans ad-hoc（单条命令）    共同点 批量管理,使用模块 批量管理,使用模块   区别 方便重复调用 不是很方便，不容易重复   应用建议(应用场景) 部署服务，多个步骤的任务 测试模块，临时性任务   1.2 剧本的书写格式剧本的书写格式   书写playbook注意事项:  同一个层级的内容对齐的. 不同层级的通过2个空格对齐 不能使用tab键   1.3 第一个剧本使用剧本在对象机器创建文件 123456789101112131415161718192021222324252627282930313233343536373839404142434445# 01、创建剧本文件[root@mn01[...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E5%A4%B4%E5%83%8F.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"></div><div class="author-info-name">Haris</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">211</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">30</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible%E9%9B%86%E7%BE%A4%E8%87%AA%E5%8A%A8%E5%8C%96%E7%BB%B4%E6%8A%A4"><span class="toc-text">Ansible集群自动化维护</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Ansible%E6%A6%82%E8%BF%B0"><span class="toc-text">1.1 Ansible概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Ansible%E7%9A%84%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6"><span class="toc-text">1.2 Ansible的管理框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E9%83%A8%E7%BD%B2%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-text">1.3 部署与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E5%AE%89%E8%A3%85"><span class="toc-text">1.3.1 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-%E5%88%9D%E5%A7%8B%E9%85%8D%E7%BD%AE"><span class="toc-text">1.3.2 初始配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Ans-inventory%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95"><span class="toc-text">1.3  Ans-inventory主机清单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E4%B8%BB%E6%9C%BA%E6%B8%85%E5%8D%95%E7%9A%84%E6%A0%BC%E5%BC%8F"><span class="toc-text">1.3.1 主机清单的格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-%E5%AD%90%E7%BB%84"><span class="toc-text">1.3.2 子组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-%E6%8C%87%E5%AE%9A%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81"><span class="toc-text">1.3.3 指定用户名和密码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Ansible%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4 Ansible必知必会的模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E5%91%BD%E4%BB%A4%E4%B8%8E%E8%84%9A%E6%9C%AC%E7%B1%BB%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4.1 命令与脚本类模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-command%E6%A8%A1%E5%9D%97"><span class="toc-text">a) command模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-shell%E6%A8%A1%E5%9D%97"><span class="toc-text">b) shell模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-script-%E6%A8%A1%E5%9D%97"><span class="toc-text">c) script 模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-%E6%96%87%E4%BB%B6%E7%9B%B8%E5%85%B3%E7%9A%84%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4.2 文件相关的模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-file%E6%A8%A1%E5%9D%97"><span class="toc-text">a) file模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-copy%E6%A8%A1%E5%9D%97"><span class="toc-text">b) copy模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-lineinfile%E6%A8%A1%E5%9D%97"><span class="toc-text">c) lineinfile模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4.3 服务管理模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-4-%E8%BD%AF%E4%BB%B6%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4.4 软件管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-yum%E6%A8%A1%E5%9D%97"><span class="toc-text">a) yum模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-get-url%E6%A8%A1%E5%9D%97"><span class="toc-text">b) get_url模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c-yum-repository%E6%A8%A1%E5%9D%97"><span class="toc-text">c) yum_repository模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-5-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4.5 用户管理模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-user%E6%A8%A1%E5%9D%97"><span class="toc-text">a) user模块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b-group%E6%A8%A1%E5%9D%97"><span class="toc-text">b) group模块</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-6-mount%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4.6 mount模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-7-cron%E6%A8%A1%E5%9D%97"><span class="toc-text">1.4.7 cron模块</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/21/06_%E6%9D%82%E8%AE%B0/ollama%E8%BF%90%E8%A1%8Cdeepseek%E5%A4%A7%E6%A8%A1%E5%9E%8B/" title="8卡A800运行DeepseekR1-671B大模型">8卡A800运行DeepseekR1-671B大模型</a><time datetime="2025-04-21T06:29:52.000Z" title="发表于 2025-04-21 14:29:52">2025-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/26/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/06-Docker%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D/" title="06-Docker资源配额">06-Docker资源配额</a><time datetime="2025-03-26T07:12:52.000Z" title="发表于 2025-03-26 15:12:52">2025-03-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/20/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/05-Docker%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/" title="05-Docker容器数据持久化">05-Docker容器数据持久化</a><time datetime="2025-03-20T07:12:52.000Z" title="发表于 2025-03-20 15:12:52">2025-03-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/12/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/04-Dockerfile%E5%AE%9E%E6%88%98%E7%AF%87-%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F/" title="04-Dockerfile实战篇-构建镜像">04-Dockerfile实战篇-构建镜像</a><time datetime="2025-03-12T07:12:52.000Z" title="发表于 2025-03-12 15:12:52">2025-03-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/04/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/03-Dockerfile%E5%9F%BA%E7%A1%80%E7%AF%87-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/" title="03-Dockerfile基础篇-基本语法">03-Dockerfile基础篇-基本语法</a><time datetime="2025-03-04T07:12:52.000Z" title="发表于 2025-03-04 15:12:52">2025-03-04</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">©2019 - 2025 By Haris</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><div class="js-pjax"></div><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>