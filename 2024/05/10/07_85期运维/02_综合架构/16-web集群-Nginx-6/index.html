<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>16-Web集群-Nginx(六) | 迎风之豚的博客</title><meta name="author" content="Haris"><meta name="copyright" content="Haris"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Web集群-Nginx（六）今日内容：  常见负载均衡轮询算法（面试会问） rewriter规则  一、轮询算法什么是轮询算法？  决定负载均衡如何把请求分发给后端节点 这种分发的方式就是轮询算法  1.1 常见轮询算法   轮询算法 说明    rr轮询 round robin 轮询,默认的循环访问.   wrr 加权轮询，在轮询的基础上增加权重功能。 server中的weight就是加权轮询。">
<meta property="og:type" content="article">
<meta property="og:title" content="16-Web集群-Nginx(六)">
<meta property="og:url" content="http://gsproj.github.io/2024/05/10/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/16-web%E9%9B%86%E7%BE%A4-Nginx-6/index.html">
<meta property="og:site_name" content="迎风之豚的博客">
<meta property="og:description" content="Web集群-Nginx（六）今日内容：  常见负载均衡轮询算法（面试会问） rewriter规则  一、轮询算法什么是轮询算法？  决定负载均衡如何把请求分发给后端节点 这种分发的方式就是轮询算法  1.1 常见轮询算法   轮询算法 说明    rr轮询 round robin 轮询,默认的循环访问.   wrr 加权轮询，在轮询的基础上增加权重功能。 server中的weight就是加权轮询。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://gsproj.github.io/img/%E7%BA%A2%E7%8C%AA.png">
<meta property="article:published_time" content="2024-05-10T02:23:52.000Z">
<meta property="article:modified_time" content="2024-08-02T01:48:34.361Z">
<meta property="article:author" content="Haris">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://gsproj.github.io/img/%E7%BA%A2%E7%8C%AA.png"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "16-Web集群-Nginx(六)",
  "url": "http://gsproj.github.io/2024/05/10/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/16-web%E9%9B%86%E7%BE%A4-Nginx-6/",
  "image": "http://gsproj.github.io/img/%E7%BA%A2%E7%8C%AA.png",
  "datePublished": "2024-05-10T02:23:52.000Z",
  "dateModified": "2024-08-02T01:48:34.361Z",
  "author": [
    {
      "@type": "Person",
      "name": "Haris",
      "url": "http://gsproj.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://gsproj.github.io/2024/05/10/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/16-web%E9%9B%86%E7%BE%A4-Nginx-6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '16-Web集群-Nginx(六)',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/吊床.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/%E7%BA%A2%E7%8C%AA.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">208</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/吊床.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">迎风之豚的博客</span></a><a class="nav-page-title" href="/"><span class="site-name">16-Web集群-Nginx(六)</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">16-Web集群-Nginx(六)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-10T02:23:52.000Z" title="发表于 2024-05-10 10:23:52">2024-05-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-02T01:48:34.361Z" title="更新于 2024-08-02 09:48:34">2024-08-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%90%E7%BB%B4/%EF%BC%88%E4%BA%8C%EF%BC%89%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/">（二）综合架构</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Web集群-Nginx（六）"><a href="#Web集群-Nginx（六）" class="headerlink" title="Web集群-Nginx（六）"></a>Web集群-Nginx（六）</h1><p>今日内容：</p>
<ol>
<li>常见负载均衡轮询算法（面试会问）</li>
<li>rewriter规则</li>
</ol>
<h1 id="一、轮询算法"><a href="#一、轮询算法" class="headerlink" title="一、轮询算法"></a>一、轮询算法</h1><p>什么是轮询算法？</p>
<ul>
<li>决定负载均衡如何把请求分发给后端节点</li>
<li>这种分发的方式就是轮询算法</li>
</ul>
<h2 id="1-1-常见轮询算法"><a href="#1-1-常见轮询算法" class="headerlink" title="1.1 常见轮询算法"></a>1.1 常见轮询算法</h2><table>
<thead>
<tr>
<th>轮询算法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>rr轮询</td>
<td>round robin 轮询,默认的循环访问.</td>
</tr>
<tr>
<td>wrr</td>
<td>加权轮询，在轮询的基础上增加权重功能。 <br/>server中的weight就是加权轮询。</td>
</tr>
<tr>
<td>ip_hash</td>
<td>ip哈希，只要客户端ip一样，就会一直访问同一个后端节点.(用户请求与web服务器绑定)<br/>用于解决会话保持&#x2F;会话共享。 <br/>可能导致负载不均。</td>
</tr>
<tr>
<td>xxx_hash</td>
<td>如url_hash<br/>只要用户访问的url相同&#x2F;uri相同,就访问相同的web服务器. <br/>用于缓存服务器：静态资源缓存</td>
</tr>
<tr>
<td>least_conn;</td>
<td>最小连接数，lc算法。<br/> 也可以配合上权重 weight, wlc权重的最小连接数</td>
</tr>
<tr>
<td>一致性hash算法</td>
<td>自己研究</td>
</tr>
</tbody></table>
<h2 id="1-2-轮询算法实现案例"><a href="#1-2-轮询算法实现案例" class="headerlink" title="1.2 轮询算法实现案例"></a>1.2 轮询算法实现案例</h2><h3 id="1-2-1-ip-hash"><a href="#1-2-1-ip-hash" class="headerlink" title="1.2.1 ip_hash"></a>1.2.1 ip_hash</h3><p>lb01配置如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01[ /etc/nginx/conf.d]#cat phpmyadmin.oldboylinux.cn.conf</span><br><span class="line">upstream phpmyadmin_spools&#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">开启ip <span class="built_in">hash</span></span></span><br><span class="line">  ip_hash;</span><br><span class="line">  server 10.0.0.7:80 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">  server 10.0.0.8:80 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="1-2-2-url-hash"><a href="#1-2-2-url-hash" class="headerlink" title="1.2.2 url_hash"></a>1.2.2 url_hash</h3><p>lb01配置如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01[ /etc/nginx/conf.d]#cat phpmyadmin.oldboylinux.cn.conf</span><br><span class="line">upstream phpmyadmin_spools&#123;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">开启url <span class="built_in">hash</span></span></span><br><span class="line">  hash $request_uri;</span><br><span class="line">  server 10.0.0.7:80 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">  server 10.0.0.8:80 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>补充：</p>
<p>hash算法下，一台机器宕机，会报错吗？</p>
<ul>
<li>不会报错，会切换到另外的机器上</li>
</ul>
</blockquote>
<h1 id="二、负载均衡状态检查"><a href="#二、负载均衡状态检查" class="headerlink" title="二、负载均衡状态检查"></a>二、负载均衡状态检查</h1><p>主要内容：</p>
<ul>
<li>掌握负载均衡状态检查模块的使用 — 基于Tengine</li>
<li>需要使用到第三方中间件（Tengine），编译安装，生成nginx命令文件</li>
<li>用tengine源码编译生成的nginx文件替换原来的nginx</li>
</ul>
<p>步骤：</p>
<ul>
<li>找一台<font color=red>db01</font>(无ngx即可)，编译tengine</li>
<li>生成ngx命令，替代lb上ngx的命令即可</li>
</ul>
<blockquote>
<p>tengine是什么？</p>
<ul>
<li>Tengine是阿里基于Nginx二次开发的高性能HTTP服务器</li>
<li>它把ngx常用的第3方模块放在了源代码中的modules目录下面，</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="comment"># 编译安装的时候增加upstream_check模块</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">--add-module=modules/ngx_http_upstream_check_module</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="comment"># 增加会话共享模块</span></span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">--add-module=modules/ngx_http_upstream_session_sticky_module/</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="2-1-编译tengine"><a href="#2-1-编译tengine" class="headerlink" title="2.1 编译tengine"></a>2.1 编译tengine</h2><p>下载tengine代码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://tengine.taobao.org/download/tengine-3.1.0.tar.gz</span><br></pre></td></tr></table></figure>

<p>安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pcre* openssl-devel</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">configure</span></span><br><span class="line">./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27; --with-ld-opt=&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27; --add-module=modules/ngx_http_upstream_check_module --add-module=modules/ngx_http_upstream_session_sticky_module/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译</span></span><br><span class="line">make -j 2</span><br></pre></td></tr></table></figure>

<p>编译完成不需要install安装，检查编译后生成的命令即可  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./objs/nginx -V</span><br><span class="line"></span><br><span class="line">Tengine version: Tengine/3.1.0</span><br><span class="line">nginx version: nginx/1.24.0</span><br></pre></td></tr></table></figure>

<h2 id="2-2-替换nginx命令"><a href="#2-2-替换nginx命令" class="headerlink" title="2.2 替换nginx命令"></a>2.2 替换nginx命令</h2><p>把在db01编译出的tengine-nginx命令文件，替换到lb01中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止服务</span></span><br><span class="line">systemctl stop nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制过去</span></span><br><span class="line">[root@db01[ /server/tools/tengine-3.1.0/objs]#scp nginx 10.0.0.5:/root/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lb01备份</span></span><br><span class="line">[root@lb01[ /etc/nginx/conf.d]#nginx -version</span><br><span class="line">nginx version: nginx/1.26.0</span><br><span class="line">[root@lb01[ /etc/nginx/conf.d]#mv /sbin/nginx /sbin/nginx-1.26.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">替换</span></span><br><span class="line">[root@lb01[ /etc/nginx/conf.d]#mv /root/nginx /sbin/nginx</span><br><span class="line">[root@lb01[ /etc/nginx/conf.d]#nginx -version</span><br><span class="line">Tengine version: Tengine/3.1.0</span><br><span class="line">nginx version: nginx/1.24.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查</span></span><br><span class="line">[root@lb01[ /etc/nginx/conf.d]#nginx -t</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启服务</span></span><br><span class="line">[root@lb01[ /etc/nginx/conf.d]#systemctl restart nginx</span><br><span class="line">[root@lb01[ /etc/nginx/conf.d]#ps -ef | grep nginx</span><br><span class="line">root      24239      1  0 11:32 ?        00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">nginx     24240  24239  0 11:32 ?        00:00:00 nginx: worker process</span><br><span class="line">root      24242   2618  0 11:32 pts/0    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>

<h2 id="2-3-tengine-chek说明"><a href="#2-3-tengine-chek说明" class="headerlink" title="2.3 tengine chek说明"></a>2.3 tengine chek说明</h2><blockquote>
<p>根据官方案例进行配置：</p>
<p><a target="_blank" rel="noopener" href="https://tengine.taobao.org/document_cn/http_upstream_check_cn.html">https://tengine.taobao.org/document_cn/http_upstream_check_cn.html</a>  </p>
</blockquote>
<p>各选项说明：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream cluster1 &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 192.168.0.1:80;</span><br><span class="line">        server 192.168.0.2:80;</span><br><span class="line"></span><br><span class="line">        # curl命令访问：curl -I</span><br><span class="line">        # 超时检测：进行1000ms的超时检测, 成功2次，判定为存活，失败5次判定为失效</span><br><span class="line">        check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line"></span><br><span class="line">        # 请求方法URI（uri最好反应业务是否正常，找开发写个页面）</span><br><span class="line">        check_http_send &quot;HEAD / HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">        </span><br><span class="line">        # 认为是成功的状态码 2xx 3xx</span><br><span class="line">        check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    upstream cluster2 &#123;</span><br><span class="line">        # simple round-robin</span><br><span class="line">        server 192.168.0.3:80;</span><br><span class="line">        server 192.168.0.4:80;</span><br><span class="line"></span><br><span class="line">        check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">        check_keepalive_requests 100;</span><br><span class="line">        check_http_send &quot;HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n&quot;;</span><br><span class="line">        check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        location /1 &#123;</span><br><span class="line">            proxy_pass http://cluster1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /2 &#123;</span><br><span class="line">            proxy_pass http://cluster2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /status &#123;</span><br><span class="line">            check_status;</span><br><span class="line"></span><br><span class="line">            access_log   off;</span><br><span class="line">            # 白名单</span><br><span class="line">            allow SOME.IP.ADD.RESS;</span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>表格如下：</p>
<table>
<thead>
<tr>
<th>upstream_check模块指令说明</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>check</td>
<td>指定检查频率,失败几次,成功几次,检查间隔,检查方式</td>
</tr>
<tr>
<td>check_http_send</td>
<td>通过http方式发出请求报文,请求报文起始行,请求方法,请求的URI,请求协议(默认使用的是ip方式 访问.)</td>
</tr>
<tr>
<td>check_http_expect_alive</td>
<td>收到指定的状态码,就认为是存活的.</td>
</tr>
<tr>
<td>check_status;</td>
<td>开启负载均衡状态检查功能,web页面.location 使用 如果加强安全.</td>
</tr>
</tbody></table>
<h2 id="2-4-配置tengine-check"><a href="#2-4-配置tengine-check" class="headerlink" title="2.4 配置tengine check"></a>2.4 配置tengine check</h2><p>配置文件如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@lb01[ /etc/nginx/conf.d]#cat lb.oldboylinux.cn.conf</span><br><span class="line">upstream lb_pools &#123;</span><br><span class="line">  server 10.0.0.7:80 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">  server 10.0.0.8:80 weight=1 max_fails=3 fail_timeout=30s;</span><br><span class="line">  check interval=3000 rise=2 fall=5 timeout=1000 type=http;</span><br><span class="line">  check_http_send &quot;HEAD / HTTP/1.0\r\n\r\n&quot;;</span><br><span class="line">  check_http_expect_alive http_2xx http_3xx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name lb.oldboylinux.cn;</span><br><span class="line">  error_log /var/log/nginx/lb-error.log notice;</span><br><span class="line">  access_log /var/log/nginx/lb-access.log main;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_pass http://lb_pools;</span><br><span class="line">    proxy_set_header Host $http_host;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /lb_status &#123;</span><br><span class="line">    check_status;</span><br><span class="line">    access_log off;</span><br><span class="line">    allow 10.0.0.1;</span><br><span class="line">    allow 10.0.0.0/24;</span><br><span class="line">    deny all;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-测试"><a href="#2-5-测试" class="headerlink" title="2.5 测试"></a>2.5 测试</h2><p>重新加载nginx服务，访问测试页面：<a target="_blank" rel="noopener" href="http://lb.oldboylinux.cn/lb_status">http://lb.oldboylinux.cn/lb_status</a></p>
<p><img src="/../../../img/image-20240510114628339.png" alt="image-20240510114628339"></p>
<blockquote>
<p>注意: 如果后端web有多个虚拟主机</p>
<p>upstream check进行访问的时候默认使用的ip方式进行访问.</p>
<p>在发出http请求的时候指定域名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">check_http_send <span class="string">&quot;HEAD / HTTP/1.0\r\nHost: lb.oldboylinux.cn\r\n\r\n&quot;</span> ;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="三、Nginx平滑升级案例"><a href="#三、Nginx平滑升级案例" class="headerlink" title="三、Nginx平滑升级案例"></a>三、Nginx平滑升级案例</h1><p>平滑升级的步骤</p>
<table>
<thead>
<tr>
<th>平滑更新步骤</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>1、准备好新的nginx命令(已经测试的)</td>
<td></td>
</tr>
<tr>
<td>2、把当前环境的nginx的命令备份,使用新的替换.</td>
<td></td>
</tr>
<tr>
<td>3、通过kill命令向当前运行ngx发出信号,准备被替代 -USR2 pid</td>
<td>把当前运行ngx的pid文件改个名 使用新的nginx命令启动ngx进程</td>
</tr>
<tr>
<td>4、测试调试,关闭旧的ngx的进程即可.(kill即可.)</td>
<td></td>
</tr>
</tbody></table>
<p>找一台负载均衡服务器（lb01），执行操作</p>
<h2 id="2-1-检查当前环境"><a href="#2-1-检查当前环境" class="headerlink" title="2.1 检查当前环境"></a>2.1 检查当前环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Nginx版本</span></span><br><span class="line">[root@lb01[ /]#nginx -v</span><br><span class="line">nginx version: nginx/1.26.0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动nginx</span></span><br><span class="line">[root@lb01[ /]#systemctl start nginx</span><br><span class="line">[root@lb01[ /]#ps -ef | grep ngxin</span><br><span class="line">root      24726   2618  0 13:55 pts/0    00:00:00 grep --color=auto ngxin</span><br><span class="line">[root@lb01[ /]#ps -ef | grep nginx</span><br><span class="line">root      24239      1  0 11:32 ?        00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">nginx     24300  24239  0 11:45 ?        00:00:01 nginx: worker process</span><br><span class="line">root      24728   2618  0 13:55 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看pid</span></span><br><span class="line">[root@lb01[ /]#ll /var/run/nginx.pid</span><br><span class="line">-rw-r--r--. 1 root root 6 May 10 10:20 /var/run/nginx.pid</span><br><span class="line">[root@lb01[ /]#ll /var/run/nginx.pid*</span><br><span class="line">-rw-r--r--. 1 root root 6 May 10 10:20 /var/run/nginx.pid</span><br><span class="line">[root@lb01[ /]#cat /var/run/nginx.pid</span><br><span class="line">24239</span><br></pre></td></tr></table></figure>

<h2 id="2-2-升级nginx"><a href="#2-2-升级nginx" class="headerlink" title="2.2 升级nginx"></a>2.2 升级nginx</h2><p>替换新老nginx</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">备份旧的Nginx</span></span><br><span class="line">[root@lb01[ /]#mv /sbin/nginx /sbin/nginx-v.1.26.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将新的nginx拷贝进去</span></span><br><span class="line">[root@lb01[ /]#mv /root/tengine-nginx /sbin/nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查替换后的信息</span></span><br><span class="line">[root@lb01[ /]#nginx -v</span><br><span class="line">Tengine version: Tengine/3.1.0</span><br><span class="line">nginx version: nginx/1.24.0</span><br></pre></td></tr></table></figure>

<p>PID相关处理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">准备新老交替</span></span><br><span class="line">[root@lb01[ /]#kill -USR2 `cat /var/run/nginx.pid`</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">会生成一个新的Pid文件，并重命名旧的PID文件</span></span><br><span class="line">[root@lb01[ /var/run]#ll /var/run/nginx.pid*</span><br><span class="line">-rw-r--r--. 1 root root 6 May 10 13:42 /var/run/nginx.pid</span><br><span class="line">-rw-r--r--. 1 root root 6 May 10 13:41 /var/run/nginx.pid.oldbin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看oldbin里面的PID</span></span><br><span class="line">[root@lb01[ /var/run]#cat /var/run/nginx.pid.oldbin</span><br><span class="line">24239</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看现在的nginx进程</span></span><br><span class="line">[root@lb01[ /var/run]#ps -ef | grep nginx</span><br><span class="line">root      24239      1  0 11:32 ?        00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">nginx     24300  24239  0 11:45 ?        00:00:02 nginx: worker process</span><br><span class="line">root      24740  24239  0 13:57 ?        00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">nginx     24741  24740  0 13:57 ?        00:00:00 nginx: worker process</span><br><span class="line">root      24770   2618  0 13:58 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">干掉与PID对应的进程号</span></span><br><span class="line">[root@lb01[ /var/run]#kill 24239</span><br><span class="line">[root@lb01[ /var/run]#ps -ef | grep nginx</span><br><span class="line">root      24740      1  0 13:57 ?        00:00:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">nginx     24741  24740  0 13:57 ?        00:00:00 nginx: worker process</span><br><span class="line">root      24772   2618  0 13:59 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新的PID已生效</span></span><br><span class="line">[root@lb01[ /var/run]#ss -lntup | grep 80</span><br><span class="line">tcp    LISTEN     0      128       *:80                    *:*                   users:((&quot;nginx&quot;,pid=24741,fd=14),(&quot;nginx&quot;,pid=24740,fd=14))</span><br><span class="line">[root@lb01[ /var/run]#cat /var/run/nginx.pid</span><br><span class="line">24740</span><br></pre></td></tr></table></figure>



<h1 id="四、Nginx重定向功能"><a href="#四、Nginx重定向功能" class="headerlink" title="四、Nginx重定向功能"></a>四、Nginx重定向功能</h1><h2 id="4-1-概述"><a href="#4-1-概述" class="headerlink" title="4.1 概述"></a>4.1 概述</h2><p>重定向（rewrite），也叫URL重定向，也叫URL改写</p>
<p>用于未来的需求：</p>
<ul>
<li>1、URL重定向：网站是http(80) —&gt; https(443) <ul>
<li>用户<a target="_blank" rel="noopener" href="http://www.baidu.com/">http://www.baidu.com</a> —&gt; <a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com/</a></li>
</ul>
</li>
<li>2、根据客户端访问类型进行跳转（如客户端类型）<ul>
<li>如果用户的客户端是ios,iphone,android,访问m.oldboyedu.com</li>
<li>否则默认访问<a target="_blank" rel="noopener" href="http://www.oldboyedu.com/">www.oldboyedu.com</a></li>
</ul>
</li>
<li>3、新老域名跳转: <a target="_blank" rel="noopener" href="http://www.360buy.com/">www.360buy.com</a> —-&gt; jd.com</li>
<li>4、需要我们调整url格式：改成伪静态(方便搜索引擎收入) ，满足运营要求<ul>
<li><a target="_blank" rel="noopener" href="http://www.oldboylinux.cn/index.php">www.oldboylinux.cn/index.php</a></li>
<li>原站点：<a target="_blank" rel="noopener" href="https://docs.qq.com/desktop/mydoc/folder/RvMUOloshpGc?u=159d26a006074197b7a526a51aa28f55">https://docs.qq.com/desktop/mydoc/folder/RvMUOloshpGc?u=159d26a006074197b7a526a51aa28f55</a></li>
<li>伪静态：<a target="_blank" rel="noopener" href="https://docs.qq.com/desktop/mydoc/folder/RvMUOloshpGc-159d26a006074197b7a526a51aa28f55.html">https://docs.qq.com/desktop/mydoc/folder/RvMUOloshpGc-159d26a006074197b7a526a51aa28f55.html</a></li>
</ul>
</li>
</ul>
<h2 id="4-2-重定向模块的指令"><a href="#4-2-重定向模块的指令" class="headerlink" title="4.2 重定向模块的指令"></a>4.2 重定向模块的指令</h2><table>
<thead>
<tr>
<th>相关的指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>return</td>
<td>实现对url的改写,一般与ngx变量一起使用，返回指定的状态码.</td>
</tr>
<tr>
<td>rewrite</td>
<td>实现对url的改写，使用正则匹配uri，进行改写.，还有各种标记.</td>
</tr>
<tr>
<td>set</td>
<td>创建或修改ngx变量.</td>
</tr>
<tr>
<td>if</td>
<td>判断,一般与ngx变量一起使用.</td>
</tr>
</tbody></table>
<h3 id="4-2-1-return指令"><a href="#4-2-1-return指令" class="headerlink" title="4.2.1 return指令"></a>4.2.1 return指令</h3><table>
<thead>
<tr>
<th>格式</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>格式1</td>
<td>return code URL;返回状态码+新的url地址.</td>
</tr>
<tr>
<td>格式2</td>
<td>return code; 返回指定状态码.</td>
</tr>
<tr>
<td>放哪</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<h4 id="案例01：返回状态码"><a href="#案例01：返回状态码" class="headerlink" title="案例01：返回状态码"></a>案例01：返回状态码</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">子配置文件</span></span><br><span class="line">[root@web01[ /etc/nginx/conf.d]#cat rewrite.oldboylinux.cn.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite;</span><br><span class="line">  charset utf8;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /admin/ &#123;</span><br><span class="line">    # 重定向</span><br><span class="line">    return 403;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建对应站点目录</span></span><br><span class="line">[root@web01[ /etc/nginx/conf.d]#mkdir /app/code/rewrite</span><br><span class="line">[root@web01[ /etc/nginx/conf.d]#echo &quot;重定向测试页面&quot; &gt;/app/code/rewrite/index.html</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启服务</span></span><br><span class="line">[root@web01[ /etc/nginx/conf.d]#systemctl reload nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>return 403</p>
<p>所有人禁止访问&#x2F;admin&#x2F;页面.  </p>
</blockquote>
<p>命令行测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7</span><br><span class="line">重定向测试页面</span><br><span class="line"></span><br><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/admin/</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.26.0&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>浏览器测试：</p>
<p>访问：<a target="_blank" rel="noopener" href="http://rewrite.oldboylinux.cn/">http://rewrite.oldboylinux.cn/</a></p>
<p><img src="/../../../img/image-20240510152227461.png" alt="image-20240510152227461"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://rewrite.oldboylinux.cn/admin">http://rewrite.oldboylinux.cn/admin</a></p>
<p><img src="/../../../img/image-20240510152504420.png" alt="image-20240510152504420"></p>
<h4 id="案例02：域名间跳转"><a href="#案例02：域名间跳转" class="headerlink" title="案例02：域名间跳转"></a>案例02：域名间跳转</h4><p>用户访问<a target="_blank" rel="noopener" href="http://rewrite.oldboylinux.cn/admin/%E8%B7%B3%E8%BD%AC%E5%88%B0www.baidu.com">http://rewrite.oldboylinux.cn/admin/跳转到www.baidu.com</a>  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite;</span><br><span class="line">  charset utf8;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /admin/ &#123;</span><br><span class="line">    # 重定向</span><br><span class="line">    return 301 https://www.baidu.com;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以访问<a target="_blank" rel="noopener" href="http://rewrite.oldboylinux.cn就跳转到www.baidu.com/">http://rewrite.oldboylinux.cn就跳转到www.baidu.com</a>  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  return 301 https://www.baidu.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>curl命令行测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@web02[ /etc/php-fpm.d]#curl -Lv -H Host:rewrite.oldboylinux.cn http://10.0.0.7/admin/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">先到rewrite.oldboylinux.cn</span></span><br><span class="line">* About to connect() to 10.0.0.7 port 80 (#0)</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host:rewrite.oldboylinux.cn</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 再301跳转</span></span></span><br><span class="line">&lt; HTTP/1.1 301 Moved Permanently</span><br><span class="line">&lt; Server: nginx/1.26.0</span><br><span class="line">&lt; Date: Fri, 10 May 2024 07:31:06 GMT</span><br><span class="line">&lt; Content-Type: text/html</span><br><span class="line">&lt; Content-Length: 169</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Location: https://www.baidu.com</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再到baidu</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">GET / HTTP/1.1</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">User-Agent: curl/7.29.0</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host: www.baidu.com</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Accept: */*</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 200 OK</span></span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">...</span><br><span class="line">&lt;title&gt;百度一下，你就知道&lt;/title&gt;&lt;/head&gt; &lt;body </span><br><span class="line">...</span><br><span class="line">* Connection #1 to host www.baidu.com left intact</span><br></pre></td></tr></table></figure>

<blockquote>
<p>curl -L –location 跟随跳转：</p>
<p>响应是301、302跳转的时候使用  </p>
</blockquote>
<h4 id="案例03：http跳转https（TODO）"><a href="#案例03：http跳转https（TODO）" class="headerlink" title="案例03：http跳转https（TODO）"></a>案例03：http跳转https（TODO）</h4><p>完整流程等讲完https再说，大致如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  return 302</span><br><span class="line">  https://rewrite.oldboylinux.cn$request_uri;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite/;</span><br><span class="line">  私钥</span><br><span class="line">  公钥(证书)</span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-2-2-if指令"><a href="#4-2-2-if指令" class="headerlink" title="4.2.2 if指令"></a>4.2.2 if指令</h3><p>if可以用于进行判断，配合ngx中的变量使用：</p>
<ul>
<li>可以比大小.</li>
<li>也可以进行等于,不等于.</li>
<li>也可以进行匹配(过滤).</li>
</ul>
<p>格式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (条件) &#123;</span><br><span class="line">满足条件执行的内容.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以放在：</p>
<ul>
<li>server、location</li>
</ul>
<p>可以使用的符号：</p>
<ul>
<li>常用<code>~, ~*, !~, !~*</code>匹配正则</li>
<li><code>~</code>大小写敏感，<code>~*</code>大小写不敏感</li>
<li>ngx取反,排除,只能用if</li>
</ul>
<h4 id="案例01：限定请求方法"><a href="#案例01：限定请求方法" class="headerlink" title="案例01：限定请求方法"></a>案例01：限定请求方法</h4><p>rewrite.oldboylinux.cn 网站只准许GET、POST这2种请求方法，其他访问禁止访问  </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@web01[ /etc/nginx/conf.d]#cat rewrite.oldboylinux.cn.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite;</span><br><span class="line">  charset utf8;</span><br><span class="line"></span><br><span class="line">  if ($request_method !~ &quot;GET|POST&quot;) &#123;</span><br><span class="line">    return 403;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">GET请求正常</span></span><br><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/</span><br><span class="line">重定向测试页面</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">HEAD请求失败</span></span><br><span class="line">[root@web02[ /etc/php-fpm.d]#curl -I -H Host:rewrite.oldboylinux.cn http://10.0.0.7/</span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Server: nginx/1.26.0</span><br><span class="line">Date: Fri, 10 May 2024 07:45:10 GMT</span><br><span class="line">Content-Type: text/html; charset=utf8</span><br><span class="line">Content-Length: 153</span><br><span class="line">Connection: keep-alive</span><br></pre></td></tr></table></figure>

<h3 id="4-2-3-set指令"><a href="#4-2-3-set指令" class="headerlink" title="4.2.3 set指令"></a>4.2.3 set指令</h3><p>用于自己创建或修改ngx变量 ，一般与<code>if</code>搭配使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">shell变量写法</span></span><br><span class="line">oldboy=666</span><br><span class="line">echo $oldboy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ngx中变量写法，进行赋值与进行使用都需要加上$符号</span></span><br><span class="line">set $变量 值;</span><br><span class="line">set $lidao 996;</span><br></pre></td></tr></table></figure>

<h4 id="案例01：基本使用"><a href="#案例01：基本使用" class="headerlink" title="案例01：基本使用"></a>案例01：基本使用</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@web01[ /etc/nginx/conf.d]#cat rewrite.oldboylinux.cn.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite;</span><br><span class="line">  charset utf8;</span><br><span class="line">  set $oldboy &quot;lidao996&quot;;</span><br><span class="line">  return 200 $oldboy;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">内容变成变量值了</span></span><br><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/</span><br><span class="line">lidao996</span><br></pre></td></tr></table></figure>

<p>可以根据变量显示网站uri</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@web01[ /etc/nginx/conf.d]#!cat</span><br><span class="line">cat rewrite.oldboylinux.cn.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite;</span><br><span class="line">  charset utf8;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">变量设置成uri</span></span><br><span class="line">  set $oldboy $http_host$request_uri;</span><br><span class="line">  return 200 $oldboy;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试访问，显示输入的uri</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/</span><br><span class="line">rewrite.oldboylinux.cn/</span><br><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/admin</span><br><span class="line">rewrite.oldboylinux.cn/admin</span><br><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/test</span><br><span class="line">rewrite.oldboylinux.cn/test</span><br></pre></td></tr></table></figure>

<h4 id="案例02：设置网站维护状态"><a href="#案例02：设置网站维护状态" class="headerlink" title="案例02：设置网站维护状态"></a>案例02：设置网站维护状态</h4><p>设置网站是否为维护状态：</p>
<ul>
<li>如果维护状态，返回503状态码</li>
<li>否则正常访问</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite;</span><br><span class="line">  charset utf8</span><br><span class="line">  set $flag 0;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">include conf.d/rewrite-status.var;</span></span><br><span class="line">  if ( $flag = 1 ) &#123;</span><br><span class="line">    return 503;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>变量文件可以单独写到一个文件中，再导入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@web01[ /etc/nginx/conf.d]#cat rewrite-status.flag</span><br><span class="line">set $flag 0;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入</span></span><br><span class="line">[root@web01[ /etc/nginx/conf.d]#cat rewrite.oldboylinux.cn.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite;</span><br><span class="line">  charset utf8;</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">导入</span></span><br><span class="line">  include conf.d/rewrite-status.flag;</span><br><span class="line">  </span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">判断</span></span><br><span class="line">  if  ($flag = 1) &#123;</span><br><span class="line">    return 503;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/</span><br><span class="line">重定向测试页面</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">中间修改flag的值，reload ngx服务</span></span><br><span class="line"></span><br><span class="line">[root@web02[ /etc/php-fpm.d]#curl -H Host:rewrite.oldboylinux.cn http://10.0.0.7/</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;503 Service Temporarily Unavailable&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;503 Service Temporarily Unavailable&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.26.0&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4-rewrite指令"><a href="#4-2-4-rewrite指令" class="headerlink" title="4.2.4 rewrite指令"></a>4.2.4 rewrite指令</h3><p>rewrite正则用于匹配用户请求的uri.</p>
<p>命令的格式与<code>sed &#39;s###g&#39;</code>类似，实现替换功能，rewrite替换url内容.(改写)</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>格式</td>
<td>rewrite 找什么(具体内容&#x2F;正则&#x2F;保护分组) 替换成什么(具体内容,后向引用) [标记]; 标记可以省略,默认使用 redirect标记(302)</td>
</tr>
<tr>
<td>放在哪里</td>
<td>server , location , if</td>
</tr>
<tr>
<td>⚠</td>
<td>rewrite匹配的内容,匹配uri.</td>
</tr>
</tbody></table>
<p>rewrite的301，302标记</p>
<table>
<thead>
<tr>
<th>rewrite的301,302标记</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>redirect</td>
<td>302</td>
</tr>
<tr>
<td>permanent</td>
<td>301</td>
</tr>
</tbody></table>
<h4 id="案例01：域名跳转"><a href="#案例01：域名跳转" class="headerlink" title="案例01：域名跳转"></a>案例01：域名跳转</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line"></span><br><span class="line">  rewrite ^(.*)$ http://www.baidu.com$1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试访问</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@web02[ /etc/php-fpm.d]#curl -Lv -H Host:rewrite.oldboylinux.cn http://10.0.0.7</span><br><span class="line">...</span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Host:rewrite.oldboylinux.cn</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">&lt; HTTP/1.1 302 Moved Temporarily</span></span><br><span class="line">...</span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Accept-Ranges: bytes</span><br><span class="line">...</span><br><span class="line">&lt;title&gt;百度一下，你就知道&lt;/title&gt;&lt;/head&gt; &lt;body link=#0000cc&gt; &lt;div </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="案例02：http跳转https（TODO）"><a href="#案例02：http跳转https（TODO）" class="headerlink" title="案例02：http跳转https（TODO）"></a>案例02：http跳转https（TODO）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="built_in">return</span> 302 https://rewrite.oldboylinux.cn<span class="variable">$request_uri</span>;</span></span><br><span class="line">  rewrite ^(.*)$ https://rewrite.oldboylinux.cn$1 ;</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">302</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  server_name rewrite.oldboylinux.cn;</span><br><span class="line">  root /app/code/rewrite/;</span><br><span class="line">  私钥</span><br><span class="line">  公钥(证书)</span><br><span class="line">  location / &#123;</span><br><span class="line">    index index.html;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="案例03：rewrite的各种标记"><a href="#案例03：rewrite的各种标记" class="headerlink" title="案例03：rewrite的各种标记"></a>案例03：rewrite的各种标记</h4><table>
<thead>
<tr>
<th>标记</th>
<th>说明</th>
<th>补充</th>
</tr>
</thead>
<tbody><tr>
<td>redirect</td>
<td>302 临时 用户访问的时候,收到302提示及新的位置Location(响应头),用户根据 Location新的位置进行访问(让用户重新发出http请求)</td>
<td>新旧地址都可以用.</td>
</tr>
<tr>
<td>permanent</td>
<td>301 永久 用户访问的时候,收到302提示及新的位置Location(响应头),用户根据 Location新的位置进行访问(让用户重新发出http请求)</td>
<td>旧的地址排名取消,旧地旧的 不用了,只用新的网站.</td>
</tr>
<tr>
<td>break</td>
<td>用户的请求匹配到包含break指令或rewrite规则后,及时后面还有location规则, 不会继续运行.终止运行.</td>
<td></td>
</tr>
<tr>
<td>last</td>
<td>用户请求匹配到包含last标记的rewrite规则后,停止继续执行,ngx会重新发出内部请求,请求与location规则进行匹配.</td>
<td>开启ngx rewrite_log才能看到</td>
</tr>
</tbody></table>
<p>rewrite标记使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">子配置文件</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name flag.oldboylinux.cn;</span><br><span class="line">  root /app/code/flag;</span><br><span class="line">  error_log /var/log/nginx/flag-error.log notice;</span><br><span class="line">  rewrite_log on; #需要错误日志debug ՎՎʢ notice</span><br><span class="line">  location / &#123;</span><br><span class="line">    # 匹配到了，继续执行</span><br><span class="line">    rewrite /1.html /2.html ;</span><br><span class="line">    # 匹配到了，继续执行</span><br><span class="line">    rewrite /2.html /3.html ;</span><br><span class="line">  &#125;</span><br><span class="line">  location /2.html &#123;</span><br><span class="line">    # 匹配到了，继续执行</span><br><span class="line">    rewrite /2.html /3.html ;</span><br><span class="line">  &#125;</span><br><span class="line">  location /3.html &#123;</span><br><span class="line">    # 匹配到了，继续执行</span><br><span class="line">    rewrite /3.html /a.html ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">准备文件</span></span><br><span class="line">echo 1.html url &gt;/app/code/flag/1.html</span><br><span class="line">echo 2.html url &gt;/app/code/flag/2.html</span><br><span class="line">echo 3.html url &gt;/app/code/flag/3.html</span><br><span class="line">echo a.html url &gt;/app/code/flag/a.html</span><br><span class="line">echo b.html url &gt;/app/code/flag/b.html</span><br></pre></td></tr></table></figure>

<p>测试rewrite：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.访问/1.html显示a.html内容</span></span><br><span class="line">[root@web01 /etc/nginx/conf.d]# curl -H Host:flag.oldboylinux.cn 10.0.0.7/1.html</span><br><span class="line">a.html url</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.访问/2.html显示a.html内容</span></span><br><span class="line">[root@web01 /etc/nginx/conf.d]# curl -H Host:flag.oldboylinux.cn 10.0.0.7/2.html</span><br><span class="line">a.html url</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>break标记使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 在rewrite /1.html /2.html的时候加上标记<span class="built_in">break</span>标记.</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">rewrite /1.html /2.html <span class="built_in">break</span>; 执行完成rewrite后会直接结束</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name flag.oldboylinux.cn;</span><br><span class="line">  root /app/code/flag;</span><br><span class="line">  error_log /var/log/nginx/flag-error.log notice;</span><br><span class="line">  rewrite_log on; #需要错误日志debug ... notice</span><br><span class="line">  location / &#123;</span><br><span class="line">    # 匹配到了，执行，遇到break，停止</span><br><span class="line">    rewrite /1.html /2.html break;</span><br><span class="line">    rewrite /2.html /3.html ;</span><br><span class="line">  &#125;</span><br><span class="line">  location /2.html &#123;</span><br><span class="line">    rewrite /2.html /3.html ;</span><br><span class="line">  &#125;</span><br><span class="line">  location /3.html &#123;</span><br><span class="line">    rewrite /3.html /a.html ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试break，跳转到2.html就结束了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 /etc/nginx/conf.d]# curl -H Host:flag.oldboylinux.cn 10.0.0.7/1.html</span><br><span class="line">2.html url</span><br></pre></td></tr></table></figure>

<p>last标记使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. 在rewrite /1.html /2.html的时候加上标记last标记。注意这一步修改下配置文件,创建新的页面b.html</span></span><br><span class="line"></span><br><span class="line">[root@web01 /etc/nginx/conf.d]# cat flag.oldboylinux.cn.conf</span><br><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name flag.oldboylinux.cn;</span><br><span class="line">  root /app/code/flag;</span><br><span class="line">  error_log /var/log/nginx/flag-error.log notice;</span><br><span class="line">  rewrite_log on; #需要错误日志debug ... notice</span><br><span class="line">  location / &#123;</span><br><span class="line">    # 匹配到了，执行，遇到last，暂停，内部重新发起请求</span><br><span class="line">    rewrite /1.html /2.html last;</span><br><span class="line">    rewrite /2.html /3.html ;</span><br><span class="line">  &#125;</span><br><span class="line">  location /2.html &#123;</span><br><span class="line">    # 收到内部发起的请求，继续处理</span><br><span class="line">    rewrite /2.html /b.html ;</span><br><span class="line">  &#125;</span><br><span class="line">  location /3.html &#123;</span><br><span class="line">    rewrite /3.html /a.html ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>last标记测试，重新发送请求，至b.html结束</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@web01 /etc/nginx/conf.d]# curl -H Host:flag.oldboylinux.cn 10.0.0.7/1.html</span><br><span class="line">b.html url</span><br></pre></td></tr></table></figure>



<h1 id="五、Nginx总结"><a href="#五、Nginx总结" class="headerlink" title="五、Nginx总结"></a>五、Nginx总结</h1><p><a target="_blank" rel="noopener" href="https://www.processon.com/view/link/63e992c0d0902d35a13e18a1">https://www.processon.com/view/link/63e992c0d0902d35a13e18a1</a> </p>
<p>访问密码：oldboylidao996  </p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://gsproj.github.io">Haris</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://gsproj.github.io/2024/05/10/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/16-web%E9%9B%86%E7%BE%A4-Nginx-6/">http://gsproj.github.io/2024/05/10/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/16-web%E9%9B%86%E7%BE%A4-Nginx-6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://gsproj.github.io" target="_blank">迎风之豚的博客</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/%E7%BA%A2%E7%8C%AA.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/05/09/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/15-web%E9%9B%86%E7%BE%A4-Nginx-5/" title="15-Web集群-Nginx(五)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">15-Web集群-Nginx(五)</div></div><div class="info-2"><div class="info-item-1">Web集群-Nginx（五）今日内容：  反向代理 vs 负载均衡区别 wordpress动态网站接入到负载均衡 其他负载案例  一、复习1.1 Nginx处理用户请求流程处理用户请求流程，静态，无负载  处理用户请求流程，动态，无负载  1.2 负载均衡处理用户请求流程参考：https://www.processon.com/view/link/619d93310e3e74287fe4e3de 二、负载均衡补充2.1 负载均衡 VS 反向代理 一般出现在面试中,如果不是一般认为这两个是一致的. 区别在于处理用户请求的方式.       内容 共同点 区别 服务    负载 均衡 用户的请求分发到 后端节点上. 用户—&gt;lb—-&gt;web lb负载均衡做的是数据转发,不会产生新的请求. 1个请求1个响应 lvs   反向 代理 用户的请求分发到后端节点上. 中间有个中介,用户—&gt;中介—&gt;web 2个请求2个响应....</div></div></div></a><a class="pagination-related" href="/2024/05/10/07_85%E6%9C%9F%E8%BF%90%E7%BB%B4/02_%E7%BB%BC%E5%90%88%E6%9E%B6%E6%9E%84/17-web%E9%9B%86%E7%BE%A4-Nginx-7-%E5%AE%8C%E7%BB%93/" title="17-Web集群-Nginx(七)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">17-Web集群-Nginx(七)</div></div><div class="info-2"><div class="info-item-1">Web集群-Nginx（七）完结今日内容：  高可用服务，keepalived 数据加密服务，https  一、HA高可用服务1.1 概述HA高可用的英文全称（HighAvailablity），学习使用软件keepalived实现， 它的实现机制：  多台服务器组成高可用集群，生成虚拟IP（Virtual IP） dns解析到这个VIP地址即可  高可用软件的选型：    选型 说明    keepalived 主给备定期发数据包，判定是否活着 高可用软件，负载使用，一般不涉及数据服务。   heartbeat 通过心跳判定高可用软件，涉及数据库，存储数据相关可以用。 heartbeat + drbd   商业高可用软件 RoseHA…略….   1.2...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/%E7%BA%A2%E7%8C%AA.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Haris</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">208</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">1</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Web%E9%9B%86%E7%BE%A4-Nginx%EF%BC%88%E5%85%AD%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">Web集群-Nginx（六）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%BD%AE%E8%AF%A2%E7%AE%97%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">一、轮询算法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E5%B8%B8%E8%A7%81%E8%BD%AE%E8%AF%A2%E7%AE%97%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 常见轮询算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E8%BD%AE%E8%AF%A2%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0%E6%A1%88%E4%BE%8B"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 轮询算法实现案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-ip-hash"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.2.1 ip_hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-url-hash"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2.2 url_hash</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%8A%B6%E6%80%81%E6%A3%80%E6%9F%A5"><span class="toc-number">3.</span> <span class="toc-text">二、负载均衡状态检查</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E7%BC%96%E8%AF%91tengine"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 编译tengine</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E6%9B%BF%E6%8D%A2nginx%E5%91%BD%E4%BB%A4"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 替换nginx命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-tengine-chek%E8%AF%B4%E6%98%8E"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 tengine chek说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E9%85%8D%E7%BD%AEtengine-check"><span class="toc-number">3.4.</span> <span class="toc-text">2.4 配置tengine check</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E6%B5%8B%E8%AF%95"><span class="toc-number">3.5.</span> <span class="toc-text">2.5 测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81Nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7%E6%A1%88%E4%BE%8B"><span class="toc-number">4.</span> <span class="toc-text">三、Nginx平滑升级案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%A3%80%E6%9F%A5%E5%BD%93%E5%89%8D%E7%8E%AF%E5%A2%83"><span class="toc-number">4.1.</span> <span class="toc-text">2.1 检查当前环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E5%8D%87%E7%BA%A7nginx"><span class="toc-number">4.2.</span> <span class="toc-text">2.2 升级nginx</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Nginx%E9%87%8D%E5%AE%9A%E5%90%91%E5%8A%9F%E8%83%BD"><span class="toc-number">5.</span> <span class="toc-text">四、Nginx重定向功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E9%87%8D%E5%AE%9A%E5%90%91%E6%A8%A1%E5%9D%97%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 重定向模块的指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-return%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.1.</span> <span class="toc-text">4.2.1 return指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B01%EF%BC%9A%E8%BF%94%E5%9B%9E%E7%8A%B6%E6%80%81%E7%A0%81"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">案例01：返回状态码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B02%EF%BC%9A%E5%9F%9F%E5%90%8D%E9%97%B4%E8%B7%B3%E8%BD%AC"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">案例02：域名间跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B03%EF%BC%9Ahttp%E8%B7%B3%E8%BD%AChttps%EF%BC%88TODO%EF%BC%89"><span class="toc-number">5.2.1.3.</span> <span class="toc-text">案例03：http跳转https（TODO）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-if%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.2.</span> <span class="toc-text">4.2.2 if指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B01%EF%BC%9A%E9%99%90%E5%AE%9A%E8%AF%B7%E6%B1%82%E6%96%B9%E6%B3%95"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">案例01：限定请求方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-set%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.3.</span> <span class="toc-text">4.2.3 set指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B01%EF%BC%9A%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">5.2.3.1.</span> <span class="toc-text">案例01：基本使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B02%EF%BC%9A%E8%AE%BE%E7%BD%AE%E7%BD%91%E7%AB%99%E7%BB%B4%E6%8A%A4%E7%8A%B6%E6%80%81"><span class="toc-number">5.2.3.2.</span> <span class="toc-text">案例02：设置网站维护状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4-rewrite%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.4.</span> <span class="toc-text">4.2.4 rewrite指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B01%EF%BC%9A%E5%9F%9F%E5%90%8D%E8%B7%B3%E8%BD%AC"><span class="toc-number">5.2.4.1.</span> <span class="toc-text">案例01：域名跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B02%EF%BC%9Ahttp%E8%B7%B3%E8%BD%AChttps%EF%BC%88TODO%EF%BC%89"><span class="toc-number">5.2.4.2.</span> <span class="toc-text">案例02：http跳转https（TODO）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B03%EF%BC%9Arewrite%E7%9A%84%E5%90%84%E7%A7%8D%E6%A0%87%E8%AE%B0"><span class="toc-number">5.2.4.3.</span> <span class="toc-text">案例03：rewrite的各种标记</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81Nginx%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">五、Nginx总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/12/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/04-Dockerfile%E5%AE%9E%E6%88%98%E7%AF%87-%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%95%9C%E5%83%8F/" title="04-Dockerfile实战篇-构建企业级镜像">04-Dockerfile实战篇-构建企业级镜像</a><time datetime="2025-03-12T07:12:52.000Z" title="发表于 2025-03-12 15:12:52">2025-03-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/04/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/03-Dockerfile%E5%9F%BA%E7%A1%80%E7%AF%87-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/" title="03-Dockerfile基础篇-基本语法">03-Dockerfile基础篇-基本语法</a><time datetime="2025-03-04T07:12:52.000Z" title="发表于 2025-03-04 15:12:52">2025-03-04</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/03/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/02-%E8%BF%90%E8%A1%8CDocker%E5%AE%B9%E5%99%A8/" title="02-运行Docker容器">02-运行Docker容器</a><time datetime="2025-03-03T07:12:52.000Z" title="发表于 2025-03-03 15:12:52">2025-03-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/03/03/09_%E9%9F%A9%E5%85%88%E8%B6%85K8S/01-Docker%E5%9F%BA%E7%A1%80/01-Dokcer%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/" title="01-Docker基础">01-Docker基础</a><time datetime="2025-03-03T04:30:52.000Z" title="发表于 2025-03-03 12:30:52">2025-03-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/02/25/06_%E6%9D%82%E8%AE%B0/Ubuntu22.04%E6%98%BE%E5%8D%A1%E7%9B%B4%E9%80%9A/" title="Ubuntu22.04显卡直通虚拟机">Ubuntu22.04显卡直通虚拟机</a><time datetime="2025-02-25T09:50:52.000Z" title="发表于 2025-02-25 17:50:52">2025-02-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/footer.png);"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Haris</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>